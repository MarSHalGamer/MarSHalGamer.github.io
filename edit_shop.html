<script>
    // ⚠️ ضع بياناتك هنا
    const BIN_ID = "6994cdcaae596e708f328b2e";
    const MASTER_KEY = "$2a$10$EVJpa1kkUQx4JG6CPhwT8eMpLADFaWQc7iR5SShpZRDJSGC2sThvi";

    let currentImageData = "";

    // جلب البيانات من السحابة وعرضها
    async function draw() {
        try {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                headers: { "X-Master-Key": MASTER_KEY }
            });
            const result = await res.json();
            const shopArray = result.record;
            const list = document.getElementById("pList");
            list.innerHTML = "";
            shopArray.forEach((it, i) => {
                list.innerHTML += `<div class="item">
                    <span><strong>${it.name}</strong> (${it.price})</span>
                    <button class="del-btn" onclick="delItem(${i})">حذف للكل</button>
                </div>`;
            });
        } catch(e) { console.error("فشل الجلب"); }
    }

    // ضغط الصورة وإضافتها
    async function handleShop() {
        const n = document.getElementById("pName").value;
        const p = document.getElementById("pPrice").value;
        const d = document.getElementById("pDesc").value;

        if(!n || !p) return alert("يرجى كتابة الاسم والسعر");

        // جلب الحالي ثم الإضافة عليه
        const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
            headers: { "X-Master-Key": MASTER_KEY }
        });
        const result = await res.json();
        let shopArray = result.record;

        // إذا كانت أول باقة حقيقية، احذف "الباقة التجريبية"
        if(shopArray.length === 1 && shopArray[0].name === "باقة تجريبية") {
            shopArray = [];
        }

        shopArray.push({ name: n, price: p, desc: d, image: currentImageData });

        // حفظ القائمة المحدثة في السحابة
        await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
            method: 'PUT',
            headers: { "Content-Type": "application/json", "X-Master-Key": MASTER_KEY },
            body: JSON.stringify(shopArray)
        });

        alert("تم الحفظ بنجاح للجميع!");
        location.reload();
    }

    async function delItem(index) {
        if(!confirm("حذف نهائي؟")) return;
        const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
            headers: { "X-Master-Key": MASTER_KEY }
        });
        const result = await res.json();
        let shopArray = result.record;
        shopArray.splice(index, 1);
        await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
            method: 'PUT',
            headers: { "Content-Type": "application/json", "X-Master-Key": MASTER_KEY },
            body: JSON.stringify(shopArray)
        });
        draw();
    }

    function previewFile() {
        const file = document.getElementById('fileInput').files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const maxWidth = 400; 
                const scale = maxWidth / img.width;
                canvas.width = maxWidth;
                canvas.height = img.height * scale;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                currentImageData = canvas.toDataURL('image/jpeg', 0.6); // ضغط الصورة 60% لتقليل المساحة
                document.getElementById('previewImg').src = currentImageData;
                document.getElementById('previewImg').style.display = 'block';
                document.getElementById('uploadText').style.display = 'none';
            };
        };
        if (file) reader.readAsDataURL(file);
    }
    window.onload = draw;
</script>
